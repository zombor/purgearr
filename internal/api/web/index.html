<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purgearr</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            margin-bottom: 30px;
            color: #4a9eff;
        }
        .section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section h2 {
            margin-bottom: 15px;
            color: #6ab7ff;
        }
        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 10px;
        }
        button:hover {
            background: #5aaeff;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .status.success {
            background: #2d5016;
            color: #90ee90;
        }
        .status.error {
            background: #501616;
            color: #ff6b6b;
        }
        .job-list {
            list-style: none;
        }
        .job-item {
            padding: 10px;
            background: #333;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .job-info {
            flex: 1;
        }
        .job-name {
            font-weight: bold;
            color: #6ab7ff;
        }
        .job-details {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 5px;
        }
        .torrent-item {
            padding: 15px;
            background: #333;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #4a9eff;
        }
        .torrent-name {
            font-weight: bold;
            color: #6ab7ff;
            margin-bottom: 8px;
        }
        .torrent-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 0.9em;
            color: #aaa;
        }
        .torrent-info-item {
            display: flex;
            flex-direction: column;
        }
        .torrent-info-label {
            color: #888;
            font-size: 0.85em;
            margin-bottom: 2px;
        }
        .torrent-info-value {
            color: #e0e0e0;
        }
        .strikes {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .strike-item {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        .strike-stalled {
            background: #ff6b6b;
            color: white;
        }
        .strike-slow {
            background: #ffa500;
            color: white;
        }
        .strike-failed {
            background: #ff4757;
            color: white;
        }
        .strike-metadl {
            background: #9b59b6;
            color: white;
        }
        .strike-none {
            background: #2d5016;
            color: #90ee90;
        }
        pre {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Purgearr</h1>
        
        <div class="section">
            <h2>Status</h2>
            <button onclick="loadStatus()">Refresh</button>
            <div id="status-content"></div>
        </div>

        <div class="section">
            <h2>Queue Cleaners</h2>
            <button onclick="loadCleaners()">Refresh</button>
            <div id="queue-cleaners"></div>
        </div>

        <div class="section">
            <h2>Download Cleaners</h2>
            <button onclick="loadCleaners()">Refresh</button>
            <div id="download-cleaners"></div>
        </div>

        <div class="section">
            <h2>Malware Blocker</h2>
            <button onclick="runMalwareBlocker()">Run Now</button>
            <div id="malware-blocker"></div>
        </div>

        <div class="section">
            <h2>Torrent Status</h2>
            <button onclick="loadTorrentStatus()">Refresh</button>
            <div id="torrent-status"></div>
        </div>

        <div class="section">
            <h2>Client Connections</h2>
            <button onclick="testSonarr()">Test Sonarr</button>
            <button onclick="testRadarr()">Test Radarr</button>
            <button onclick="testLidarr()">Test Lidarr</button>
            <button onclick="testQBittorrent()">Test qBittorrent</button>
            <div id="client-status"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1';

        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                },
            };
            if (body) {
                options.body = JSON.stringify(body);
            }
            const response = await fetch(`${API_BASE}${endpoint}`, options);
            return response.json();
        }

        async function loadStatus() {
            try {
                const status = await apiCall('/status');
                document.getElementById('status-content').innerHTML = 
                    `<pre>${JSON.stringify(status, null, 2)}</pre>`;
            } catch (error) {
                document.getElementById('status-content').innerHTML = 
                    `<div class="status error">Error: ${error.message}</div>`;
            }
        }

        async function runQueueCleaner(id) {
            try {
                await apiCall(`/cleaners/queue/${id}/run`, 'POST');
                document.getElementById('queue-cleaners').innerHTML = 
                    `<div class="status success">Queue cleaner '${id}' executed successfully</div>`;
                setTimeout(loadCleaners, 1000);
            } catch (error) {
                document.getElementById('queue-cleaners').innerHTML = 
                    `<div class="status error">Error: ${error.message}</div>`;
            }
        }

        async function runDownloadCleaner(id) {
            try {
                await apiCall(`/cleaners/download/${id}/run`, 'POST');
                document.getElementById('download-cleaners').innerHTML = 
                    `<div class="status success">Download cleaner '${id}' executed successfully</div>`;
                setTimeout(loadCleaners, 1000);
            } catch (error) {
                document.getElementById('download-cleaners').innerHTML = 
                    `<div class="status error">Error: ${error.message}</div>`;
            }
        }

        async function runMalwareBlocker() {
            try {
                await apiCall('/cleaners/malware-blocker/run', 'POST');
                document.getElementById('malware-blocker').innerHTML = 
                    `<div class="status success">Malware blocker executed successfully</div>`;
                setTimeout(loadCleaners, 1000);
            } catch (error) {
                document.getElementById('malware-blocker').innerHTML = 
                    `<div class="status error">Error: ${error.message}</div>`;
            }
        }

        async function loadCleaners() {
            try {
                const [status, config] = await Promise.all([
                    apiCall('/status'),
                    apiCall('/config')
                ]);
                const jobs = status.jobs || {};
                
                // Build sets of cleaner IDs from config (include all, not just enabled)
                // Jobs only exist if they were enabled at startup
                const queueCleanerIds = new Set();
                const downloadCleanerIds = new Set();
                
                if (config.queue_cleaners) {
                    config.queue_cleaners.forEach(qc => {
                        if (qc.id) {
                            queueCleanerIds.add(qc.id);
                        }
                    });
                }
                
                if (config.download_cleaners) {
                    config.download_cleaners.forEach(dc => {
                        if (dc.id) {
                            downloadCleanerIds.add(dc.id);
                        }
                    });
                }
                
                // Display queue cleaners
                const queueCleaners = [];
                const downloadCleaners = [];
                
                for (const [id, job] of Object.entries(jobs)) {
                    const jobData = job;
                    const jobName = jobData.name || id;
                    
                    // Skip malware blocker
                    if (id === 'malware-blocker') {
                        continue;
                    }
                    
                    // Strip prefix from job ID to get config ID
                    let configId = id;
                    let isQueueCleaner = false;
                    let isDownloadCleaner = false;
                    
                    if (id.startsWith('queue-')) {
                        configId = id.substring(6); // Remove "queue-" prefix
                        isQueueCleaner = queueCleanerIds.has(configId);
                    } else if (id.startsWith('download-')) {
                        configId = id.substring(9); // Remove "download-" prefix
                        isDownloadCleaner = downloadCleanerIds.has(configId);
                    }
                    
                    // Check if it's a queue cleaner
                    if (isQueueCleaner) {
                        const jobItem = `
                            <div class="job-item">
                                <div class="job-info">
                                    <div class="job-name">${jobName}</div>
                                    <div class="job-details">
                                        Schedule: ${jobData.schedule || 'N/A'} | 
                                        Last Run: ${jobData.last_run ? new Date(jobData.last_run).toLocaleString() : 'Never'} | 
                                        Next Run: ${jobData.next_run ? new Date(jobData.next_run).toLocaleString() : 'N/A'}
                                    </div>
                                </div>
                                <button onclick="runQueueCleaner('${configId}')">Run</button>
                            </div>
                        `;
                        queueCleaners.push(jobItem);
                    }
                    // Check if it's a download cleaner
                    else if (isDownloadCleaner) {
                        const jobItem = `
                            <div class="job-item">
                                <div class="job-info">
                                    <div class="job-name">${jobName}</div>
                                    <div class="job-details">
                                        Schedule: ${jobData.schedule || 'N/A'} | 
                                        Last Run: ${jobData.last_run ? new Date(jobData.last_run).toLocaleString() : 'Never'} | 
                                        Next Run: ${jobData.next_run ? new Date(jobData.next_run).toLocaleString() : 'N/A'}
                                    </div>
                                </div>
                                <button onclick="runDownloadCleaner('${configId}')">Run</button>
                            </div>
                        `;
                        downloadCleaners.push(jobItem);
                    }
                }
                
                document.getElementById('queue-cleaners').innerHTML = 
                    queueCleaners.length > 0 ? queueCleaners.join('') : '<div class="status">No queue cleaners configured</div>';
                document.getElementById('download-cleaners').innerHTML = 
                    downloadCleaners.length > 0 ? downloadCleaners.join('') : '<div class="status">No download cleaners configured</div>';
                
                // Display malware blocker
                const malwareBlockerJob = jobs['malware-blocker'];
                if (malwareBlockerJob) {
                    document.getElementById('malware-blocker').innerHTML = `
                        <div class="job-item">
                            <div class="job-info">
                                <div class="job-name">${malwareBlockerJob.name || 'Malware Blocker'}</div>
                                <div class="job-details">
                                    Schedule: ${malwareBlockerJob.schedule || 'N/A'} | 
                                    Last Run: ${malwareBlockerJob.last_run ? new Date(malwareBlockerJob.last_run).toLocaleString() : 'Never'} | 
                                    Next Run: ${malwareBlockerJob.next_run ? new Date(malwareBlockerJob.next_run).toLocaleString() : 'N/A'}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('malware-blocker').innerHTML = 
                        '<div class="status">Malware blocker not configured</div>';
                }
            } catch (error) {
                document.getElementById('queue-cleaners').innerHTML = 
                    `<div class="status error">Error: ${error.message}</div>`;
                document.getElementById('download-cleaners').innerHTML = 
                    `<div class="status error">Error: ${error.message}</div>`;
                document.getElementById('malware-blocker').innerHTML = 
                    `<div class="status error">Error: ${error.message}</div>`;
            }
        }

        async function testSonarr() {
            try {
                const result = await apiCall('/clients/sonarr/test');
                const statusClass = result.success ? 'success' : 'error';
                const message = result.success 
                    ? `Sonarr connection successful (version: ${result.version})`
                    : `Sonarr connection failed: ${result.error}`;
                document.getElementById('client-status').innerHTML = 
                    `<div class="status ${statusClass}">${message}</div>`;
            } catch (error) {
                document.getElementById('client-status').innerHTML = 
                    `<div class="status error">Error: ${error.message}</div>`;
            }
        }

        async function testRadarr() {
            try {
                const result = await apiCall('/clients/radarr/test');
                const statusClass = result.success ? 'success' : 'error';
                const message = result.success 
                    ? `Radarr connection successful (version: ${result.version})`
                    : `Radarr connection failed: ${result.error}`;
                document.getElementById('client-status').innerHTML = 
                    `<div class="status ${statusClass}">${message}</div>`;
            } catch (error) {
                document.getElementById('client-status').innerHTML = 
                    `<div class="status error">Error: ${error.message}</div>`;
            }
        }

        async function testLidarr() {
            try {
                const result = await apiCall('/clients/lidarr/test');
                const statusClass = result.success ? 'success' : 'error';
                const message = result.success 
                    ? `Lidarr connection successful (version: ${result.version})`
                    : `Lidarr connection failed: ${result.error}`;
                document.getElementById('client-status').innerHTML = 
                    `<div class="status ${statusClass}">${message}</div>`;
            } catch (error) {
                document.getElementById('client-status').innerHTML = 
                    `<div class="status error">Error: ${error.message}</div>`;
            }
        }

        async function testQBittorrent() {
            try {
                const result = await apiCall('/clients/qbittorrent/test');
                const statusClass = result.success ? 'success' : 'error';
                const message = result.success 
                    ? `qBittorrent connection successful (version: ${result.version})`
                    : `qBittorrent connection failed: ${result.error}`;
                document.getElementById('client-status').innerHTML = 
                    `<div class="status ${statusClass}">${message}</div>`;
            } catch (error) {
                document.getElementById('client-status').innerHTML = 
                    `<div class="status error">Error: ${error.message}</div>`;
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KiB', 'MiB', 'GiB', 'TiB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }

        function formatPercent(progress) {
            return (progress * 100).toFixed(2) + '%';
        }

        async function loadTorrentStatus() {
            try {
                const status = await apiCall('/torrents/status');
                const container = document.getElementById('torrent-status');
                
                if (!status || Object.keys(status).length === 0) {
                    container.innerHTML = '<div class="status">No torrents currently being tracked</div>';
                    return;
                }

                let html = '';
                for (const [cleanerId, torrents] of Object.entries(status)) {
                    if (torrents.length === 0) {
                        continue;
                    }
                    
                    html += `<h3 style="margin-top: 20px; margin-bottom: 10px; color: #6ab7ff;">${cleanerId}</h3>`;
                    
                    for (const torrent of torrents) {
                        const isStalled = torrent.state === 'stalledDL' || torrent.state === 'stalledUP' || torrent.state === 'stalled';
                        const hasStrikes = torrent.stalled_strikes > 0 || torrent.slow_strikes > 0 || torrent.failed_import_strikes > 0 || (torrent.metaDL_strikes || 0) > 0;
                        
                        html += `
                            <div class="torrent-item" style="border-left-color: ${hasStrikes ? '#ff6b6b' : '#4a9eff'}">
                                <div class="torrent-name">${torrent.name}</div>
                                <div class="torrent-info">
                                    <div class="torrent-info-item">
                                        <span class="torrent-info-label">State</span>
                                        <span class="torrent-info-value">${torrent.state}</span>
                                    </div>
                                    <div class="torrent-info-item">
                                        <span class="torrent-info-label">Progress</span>
                                        <span class="torrent-info-value">${formatPercent(torrent.progress)}</span>
                                    </div>
                                    <div class="torrent-info-item">
                                        <span class="torrent-info-label">Download Speed</span>
                                        <span class="torrent-info-value">${formatBytes(torrent.dlspeed)}/s</span>
                                    </div>
                                    <div class="torrent-info-item">
                                        <span class="torrent-info-label">Upload Speed</span>
                                        <span class="torrent-info-value">${formatBytes(torrent.upspeed)}/s</span>
                                    </div>
                                    <div class="torrent-info-item">
                                        <span class="torrent-info-label">Tracker</span>
                                        <span class="torrent-info-value" style="word-break: break-all;">${torrent.tracker || 'N/A'}</span>
                                    </div>
                                </div>
                                <div class="strikes">
                                    ${torrent.stalled_threshold !== null ? `
                                        <div class="strike-item ${torrent.stalled_strikes > 0 ? 'strike-stalled' : 'strike-none'}">
                                            Stalled: ${torrent.stalled_strikes}/${torrent.stalled_threshold}
                                        </div>
                                    ` : ''}
                                    ${torrent.slow_threshold !== null ? `
                                        <div class="strike-item ${torrent.slow_strikes > 0 ? 'strike-slow' : 'strike-none'}">
                                            Slow: ${torrent.slow_strikes}/${torrent.slow_threshold}
                                        </div>
                                    ` : ''}
                                    ${torrent.failed_import_threshold !== null ? `
                                        <div class="strike-item ${torrent.failed_import_strikes > 0 ? 'strike-failed' : 'strike-none'}">
                                            Failed Import: ${torrent.failed_import_strikes}/${torrent.failed_import_threshold}
                                        </div>
                                    ` : ''}
                                    ${torrent.metaDL_threshold !== null && torrent.metaDL_threshold !== undefined ? `
                                        <div class="strike-item ${(torrent.metaDL_strikes || 0) > 0 ? 'strike-metadl' : 'strike-none'}">
                                            MetaDL: ${torrent.metaDL_strikes || 0}/${torrent.metaDL_threshold}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }
                }
                
                if (html === '') {
                    container.innerHTML = '<div class="status">No torrents currently being tracked</div>';
                } else {
                    container.innerHTML = html;
                }
            } catch (error) {
                document.getElementById('torrent-status').innerHTML = 
                    `<div class="status error">Error: ${error.message}</div>`;
            }
        }

        // Load status and cleaners on page load
        loadStatus();
        loadCleaners();
        loadTorrentStatus();
        
        // Auto-refresh torrent status every 30 seconds
        setInterval(loadTorrentStatus, 30000);
    </script>
</body>
</html>

